<!DOCTYPE html>  
<html lang="en" data-theme="light">  
<head>  
    <meta charset="utf-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1">  
    <title>ACSM Converter</title>  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">  
    <style>  
        :root {  
            --pico-font-size: 16px;  
            --accent: #4a90d9;  
            --accent-hover: #357abd;  
        }  
        body { background: #f4f6f9; }  
        header.hero {  
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);  
            color: #fff;  
            padding: 2.5rem 0;  
            margin-bottom: 2rem;  
            text-align: center;  
        }  
        header.hero h1 { color: #fff; margin-bottom: 0.25rem; }  
        header.hero p { color: #a0b4cc; margin: 0; }  
        .upload-zone {  
            border: 3px dashed #b0bec5;  
            border-radius: 12px;  
            padding: 3rem 2rem;  
            text-align: center;  
            cursor: pointer;  
            transition: all 0.3s ease;  
            background: #fff;  
            margin-bottom: 2rem;  
        }  
        .upload-zone:hover {   
            border-color: var(--accent);   
            background: #eef4fb;   
        }  
        .upload-zone.dragover {   
            border-color: var(--accent);   
            background: #dbe9f9;   
            transform: scale(1.02);  
            box-shadow: 0 4px 12px rgba(74, 144, 217, 0.2);  
        }  
        .upload-zone .icon {   
            font-size: 3rem;   
            margin-bottom: 1rem;   
        }  
        .upload-zone p {   
            margin: 0.5rem 0;   
            color: #546e7a;   
            font-size: 1.1rem;  
        }  
        .upload-zone .hint {  
            color: #90a4ae;  
            font-size: 0.9rem;  
            margin-top: 0.5rem;  
        }  
        #fileInput {  
            display: none;  
        }  
        .progress-section {  
            display: none;  
            margin-bottom: 2rem;  
        }  
        .progress-section.show {  
            display: block;  
        }  
        .progress-bar {  
            width: 100%;  
            height: 8px;  
            background: #e0e0e0;  
            border-radius: 4px;  
            overflow: hidden;  
            margin-bottom: 1rem;  
        }  
        .progress-fill {  
            height: 100%;  
            background: linear-gradient(90deg, #4a90d9, #357abd);  
            width: 0%;  
            transition: width 0.3s ease;  
        }  
        .steps-container {  
            background: #fff;  
            border-radius: 8px;  
            padding: 1.5rem;  
            margin-bottom: 1rem;  
        }  
        .step {  
            display: flex;  
            align-items: center;  
            padding: 0.75rem 0;  
            border-bottom: 1px solid #f0f0f0;  
        }  
        .step:last-child {  
            border-bottom: none;  
        }  
        .step-icon {  
            width: 24px;  
            height: 24px;  
            border-radius: 50%;  
            display: flex;  
            align-items: center;  
            justify-content: center;  
            margin-right: 1rem;  
            font-size: 0.8rem;  
            color: white;  
            font-weight: bold;  
        }  
        .step-icon.pending {  
            background: #ccc;  
        }  
        .step-icon.active {  
            background: #4a90d9;  
            animation: pulse 1s infinite;  
        }  
        .step-icon.done {  
            background: #4caf50;  
        }  
        .step-icon.error {  
            background: #f44336;  
        }  
        @keyframes pulse {  
            0%, 100% { opacity: 1; }  
            50% { opacity: 0.7; }  
        }  
        .step-text {  
            flex: 1;  
        }  
        .step-text.done {  
            color: #4caf50;  
        }  
        .step-text.error {  
            color: #f44336;  
        }  
        .result-section {  
            display: none;  
            background: #fff;  
            border-radius: 12px;  
            padding: 2rem;  
            text-align: center;  
        }  
        .result-section.show {  
            display: block;  
        }  
        .result-section.success {  
            border: 2px solid #4caf50;  
        }  
        .result-section.error {  
            border: 2px solid #f44336;  
        }  
        .result-icon {  
            font-size: 3rem;  
            margin-bottom: 1rem;  
        }  
        .result-section h2 {  
            margin-bottom: 1rem;  
        }  
        .button-group {  
            display: flex;  
            gap: 1rem;  
            justify-content: center;  
            margin-top: 1rem;  
        }  
        .button-group button {  
            flex: 1;  
            max-width: 200px;  
        }  
        main {  
            max-width: 800px;  
            margin: 0 auto;  
            padding: 0 1rem;  
        }  
    </style>  
</head>  
<body>  
    <header class="hero">  
        <h1>üìö ACSM Converter</h1>  
        <p>Convert Adobe ACSM files to DRM-free EPUB</p>  
    </header>  
    <main>  
        <!-- Upload Section -->  
        <section id="uploadSection">  
            <div class="upload-zone" id="uploadZone">  
                <div class="icon">üìÅ</div>  
                <p><strong>Click to select an .acsm file</strong></p>  
                <p>or drag and drop it here</p>  
                <p class="hint">Only .acsm files are supported</p>  
            </div>  
            <input type="file" id="fileInput" accept=".acsm" />  
        </section>  
        <!-- Progress Section -->  
        <section id="progressSection" class="progress-section">  
            <h3>Converting: <span id="convertingName"></span></h3>  
            <div class="progress-bar">  
                <div class="progress-fill" id="progressFill"></div>  
            </div>  
            <div class="steps-container" id="stepsContainer"></div>  
        </section>  
        <!-- Result Section -->  
        <section id="resultSection" class="result-section">  
            <div class="result-icon" id="resultIcon"></div>  
            <h2 id="resultTitle"></h2>  
            <p id="resultMessage"></p>  
            <div id="downloadContainer"></div>  
            <div class="button-group">  
                <button id="resultReset" class="contrast">Convert Another File</button>  
            </div>  
        </section>  
    </main>  
    <script>  
        const uploadZone = document.getElementById('uploadZone');  
        const fileInput = document.getElementById('fileInput');  
        const uploadSection = document.getElementById('uploadSection');  
        const progressSection = document.getElementById('progressSection');  
        const convertingName = document.getElementById('convertingName');  
        const progressFill = document.getElementById('progressFill');  
        const stepsContainer = document.getElementById('stepsContainer');  
        const resultSection = document.getElementById('resultSection');  
        const resultIcon = document.getElementById('resultIcon');  
        const resultTitle = document.getElementById('resultTitle');  
        const resultMessage = document.getElementById('resultMessage');  
        const downloadContainer = document.getElementById('downloadContainer');  
        const resultReset = document.getElementById('resultReset');  
        const stepDivs = {};  
        // File input click handler  
        uploadZone.addEventListener('click', () => fileInput.click());  
        // File input change handler  
        fileInput.addEventListener('change', (e) => {  
            if (e.target.files[0]) {  
                handleFileSelect(e.target.files[0]);  
            }  
        });  
        // Drag and drop handlers - FIXED  
        uploadZone.addEventListener('dragover', (e) => {  
            e.preventDefault();  
            e.stopPropagation();  
            uploadZone.classList.add('dragover');  
        });  
        uploadZone.addEventListener('dragleave', (e) => {  
            e.preventDefault();  
            e.stopPropagation();  
            uploadZone.classList.remove('dragover');  
        });  
        uploadZone.addEventListener('drop', (e) => {  
            e.preventDefault();  
            e.stopPropagation();  
            uploadZone.classList.remove('dragover');  
              
            const files = e.dataTransfer.files;  
            if (files.length > 0) {  
                handleFileSelect(files[0]);  
            }  
        });  
        // Prevent default drag behavior on document  
        document.addEventListener('dragover', (e) => e.preventDefault());  
        document.addEventListener('drop', (e) => e.preventDefault());  
        function handleFileSelect(file) {  
            // Validate file type  
            if (!file.name.toLowerCase().endsWith('.acsm')) {  
                alert('Please select an .acsm file');  
                return;  
            }  
            uploadFile(file);  
        }  
        async function uploadFile(file) {  
            try {  
                console.log('[DEBUG] Uploading file:', file.name);  
                const formData = new FormData();  
                formData.append('file', file);  
                  
                const response = await fetch('/upload', {  
                    method: 'POST',  
                    body: formData  
                });  
                if (!response.ok) {  
                    throw new Error(`Upload failed with status ${response.status}`);  
                }  
                const data = await response.json();  
                console.log('[DEBUG] Upload response:', data);  
                if (data.error) {  
                    alert('Upload error: ' + data.error);  
                    return;  
                }  
                startConversion(data.filename);  
            } catch (err) {  
                console.error('[DEBUG] Upload error:', err);  
                alert('Upload failed: ' + err.message);  
            }  
        }  
        async function startConversion(filename) {  
            console.log('[DEBUG] Starting conversion for:', filename);  
            uploadSection.style.display = 'none';  
            progressSection.classList.add('show');  
            convertingName.textContent = filename;  
            stepsContainer.innerHTML = '';  
            progressFill.style.width = '0%';  
            Object.keys(stepDivs).forEach(k => delete stepDivs[k]);  
            try {  
                const response = await fetch(`/start-convert/${encodeURIComponent(filename)}`, {  
                    method: 'POST'  
                });  
                if (!response.ok) {  
                    throw new Error(`Conversion start failed with status ${response.status}`);  
                }  
                const data = await response.json();  
                console.log('[DEBUG] Conversion started:', data);  
                if (data.error) {  
                    showError('Conversion Error', data.error);  
                    return;  
                }  
                const jobId = data.job_id;  
                pollConversionStatus(jobId, filename);  
            } catch (err) {  
                console.error('[DEBUG] Conversion start error:', err);  
                showError('Conversion Error', err.message);  
            }  
        }  
        async function pollConversionStatus(jobId, filename) {  
            const maxAttempts = 300;  
            let attempts = 0;  
            const poll = async () => {  
                try {  
                    const response = await fetch(`/job-status/${jobId}`);  
                    if (!response.ok) {  
                        throw new Error(`Status check failed with status ${response.status}`);  
                    }  
                    const data = await response.json();  
                    console.log('[DEBUG] Status:', data);  
                    // Update progress  
                    if (data.steps) {  
                        updateSteps(data.steps);  
                        const completedSteps = data.steps.filter(s => s.step === 'done' || typeof s.step === 'number').length;  
                        const totalSteps = 5;  
                        const progress = (completedSteps / totalSteps) * 100;  
                        progressFill.style.width = progress + '%';  
                    }  
                    if (data.status === 'done') {  
                        showSuccess('Conversion Complete!', filename, data.done_message);  
                        return;  
                    } else if (data.status === 'error') {  
                        showError('Conversion Failed', data.error || 'Unknown error');  
                        return;  
                    }  
                    attempts++;  
                    if (attempts < maxAttempts) {  
                        setTimeout(poll, 1000);  
                    } else {  
                        showError('Conversion Timeout', 'The conversion took too long');  
                    }  
                } catch (err) {  
                    console.error('[DEBUG] Poll error:', err);  
                    showError('Status Check Error', err.message);  
                }  
            };  
            poll();  
        }  
        function updateSteps(steps) {  
            steps.forEach((step, index) => {  
                if (!stepDivs[index]) {  
                    const stepDiv = document.createElement('div');  
                    stepDiv.className = 'step';  
                    const status = step.step === 'done' ? 'done' : 'active';  
                    const icon = step.step === 'done' ? '‚úì' : '‚ü≥';  
                    stepDiv.innerHTML = `  
                        <div class="step-icon ${status}">${icon}</div>  
                        <div class="step-text ${status}">${step.message}</div>  
                    `;  
                    stepsContainer.appendChild(stepDiv);  
                    stepDivs[index] = stepDiv;  
                }  
            });  
        }  
        function showSuccess(title, filename, message) {  
            progressSection.classList.remove('show');  
            resultSection.classList.add('show', 'success');  
            resultIcon.textContent = '‚úÖ';  
            resultTitle.textContent = title;  
            resultMessage.textContent = message || `Successfully converted: ${filename}`;  
              
            downloadContainer.innerHTML = `  
                <a href="/download/${encodeURIComponent(filename.replace('.acsm', '.epub'))}" class="button contrast" download>  
                    üì• Download EPUB  
                </a>  
            `;  
        }  
        function showError(title, message) {  
            progressSection.classList.remove('show');  
            resultSection.classList.add('show', 'error');  
            resultIcon.textContent = '‚ùå';  
            resultTitle.textContent = title;  
            resultMessage.textContent = message;  
            downloadContainer.innerHTML = '';  
        }  
        resultReset.addEventListener('click', () => {  
            fileInput.value = '';  
            resultSection.classList.remove('show', 'success', 'error');  
            uploadSection.style.display = 'block';  
            progressSection.classList.remove('show');  
        });  
    </script>  
</body>  
</html>  
