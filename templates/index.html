<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ACSM Converter</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <style>
        :root {
            --pico-font-size: 16px;
            --accent: #4a90d9;
            --accent-hover: #357abd;
        }
        body { background: #f4f6f9; }
        header.hero {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #fff;
            padding: 2.5rem 0;
            margin-bottom: 2rem;
            text-align: center;
        }
        header.hero h1 { color: #fff; margin-bottom: 0.25rem; }
        header.hero p { color: #a0b4cc; margin: 0; }

        .drop-zone {
            border: 2px dashed #b0bec5;
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s;
            background: #fff;
            margin-bottom: 2rem;
        }
        .drop-zone:hover { border-color: var(--accent); background: #eef4fb; }
        .drop-zone.dragover { border-color: var(--accent); background: #dbe9f9; transform: scale(1.01); }
        .drop-zone .icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
        .drop-zone p { margin: 0; color: #546e7a; }

        .book-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 1.5rem;
        }
        .book-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
            display: flex;
            flex-direction: row;
            transition: box-shadow 0.2s;
        }
        .book-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.14); }
        .book-cover {
            width: 120px;
            min-height: 160px;
            background: linear-gradient(135deg, #e0e0e0, #bdbdbd);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
        }
        .book-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .book-cover .placeholder {
            font-size: 2.5rem;
            color: #9e9e9e;
        }
        .book-info {
            padding: 1rem 1.25rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            flex: 1;
            min-width: 0;
        }
        .book-info h4 {
            margin: 0 0 0.75rem 0;
            font-size: 1.05rem;
            word-break: break-word;
        }
        .book-files { display: flex; flex-direction: column; gap: 0.4rem; }
        .book-file {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
        }
        .file-badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.03em;
        }
        .file-badge.epub { background: #e8f5e9; color: #2e7d32; }
        .file-badge.pdf { background: #fce4ec; color: #c62828; }
        .file-size { color: #78909c; font-size: 0.85rem; }
        .btn-dl {
            display: inline-block;
            padding: 0.3rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            text-decoration: none;
            color: #fff;
            background: var(--accent);
            transition: background 0.2s;
            white-space: nowrap;
        }
        .btn-dl:hover { background: var(--accent-hover); color: #fff; }

        .btn-convert-epub {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.35rem 0.85rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            color: #2e7d32;
            background: #e8f5e9;
            border: 1px solid #a5d6a7;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 0.5rem;
        }
        .btn-convert-epub:hover { background: #c8e6c9; }
        .btn-convert-epub:disabled { opacity: 0.6; cursor: default; }

        .epub-converting {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: #546e7a;
        }
        .epub-converting .mini-spinner {
            display: inline-block;
            width: 14px; height: 14px;
            border: 2px solid var(--accent);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        .btn-stop {
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            color: #c62828;
            background: #fce4ec;
            border: 1px solid #ef9a9a;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-stop:hover { background: #ffcdd2; }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }
        .step { padding: 0.3rem 0; }
        .step[data-status="active"] { font-weight: bold; }
        .step[data-status="done"]::before { content: "\2713 "; color: #2e7d32; }
        .step[data-status="active"]::before {
            content: "";
            display: inline-block;
            width: 14px; height: 14px;
            border: 2px solid var(--accent);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            vertical-align: middle;
            margin-right: 6px;
        }
        .step[data-status="error"]::before { content: "\2717 "; color: #c62828; }
        .step .elapsed {
            font-weight: normal;
            font-size: 0.8rem;
            color: #78909c;
            margin-left: 0.5rem;
        }
        .step-hint {
            font-size: 0.85rem;
            color: #78909c;
            padding: 0.25rem 0 0 1.5rem;
            animation: pulse 2s ease-in-out infinite;
        }
        #confirm-section, #progress-section { display: none; }
        #confirm-section, #progress-section {
            background: #fff;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }
        section h3 { margin-top: 0; }
        .confirm-filename { font-weight: 600; word-break: break-all; }
        .confirm-buttons { display: flex; gap: 1rem; margin-top: 1rem; }
        .confirm-buttons button { flex: 1; }
    </style>
</head>
<body>
    <header class="hero">
        <div class="container">
            <h1>ACSM Converter</h1>
            <p>Convert ACSM ebook tokens to DRM-free EPUB and PDF</p>
        </div>
    </header>

    <main class="container">
        <!-- Upload -->
        <section id="upload-section">
            <div class="drop-zone" id="drop-zone">
                <div class="icon">&#128214;</div>
                <p><strong>Drag & drop</strong> an .acsm file here, or <strong>click to browse</strong></p>
                <input type="file" id="file-input" accept=".acsm" hidden>
            </div>
        </section>

        <!-- Confirm -->
        <section id="confirm-section">
            <h3>Ready to Convert</h3>
            <p>File: <span class="confirm-filename" id="confirm-filename"></span></p>
            <p>This will download the ebook and remove DRM protection.</p>
            <div class="confirm-buttons">
                <button id="confirm-cancel" class="secondary outline">Cancel</button>
                <button id="confirm-start">Start Conversion</button>
            </div>
        </section>

        <!-- Progress -->
        <section id="progress-section">
            <h3>Converting: <span id="converting-name"></span></h3>
            <progress id="progress-bar" value="0" max="5" style="margin-bottom:1rem"></progress>
            <div id="steps"></div>
        </section>


        <!-- History -->
        {% if books %}
        <section>
            <h3>Previously Converted</h3>
            <div class="book-grid">
                {% for book in books %}
                <article class="book-card">
                    <div class="book-cover">
                        {% if book.cover %}
                        <img src="/cover/{{ book.cover }}" alt="{{ book.stem }} cover">
                        {% else %}
                        <span class="placeholder">&#128218;</span>
                        {% endif %}
                    </div>
                    <div class="book-info">
                        <h4>{{ book.stem }}</h4>
                        <div class="book-files">
                            {% for f in book.files %}
                            <div class="book-file">
                                <span class="file-badge {{ f.ext|lower }}">{{ f.ext }}</span>
                                <span class="file-size">{{ f.size }}</span>
                                <a href="/download/{{ f.name }}" class="btn-dl">Download</a>
                            </div>
                            {% endfor %}
                        </div>
                        {% if not book.has_epub %}
                        <div id="epub-action-{{ loop.index }}" data-stem="{{ book.stem }}">
                            <button class="btn-convert-epub" onclick="startEpubConvert('{{ book.stem }}', 'epub-action-{{ loop.index }}')">
                                Convert to EPUB
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </article>
                {% endfor %}
            </div>
        </section>
        {% endif %}
    </main>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const uploadSection = document.getElementById('upload-section');
        const confirmSection = document.getElementById('confirm-section');
        const confirmFilename = document.getElementById('confirm-filename');
        const confirmStart = document.getElementById('confirm-start');
        const confirmCancel = document.getElementById('confirm-cancel');
        const progressSection = document.getElementById('progress-section');
        const stepsDiv = document.getElementById('steps');
        const progressBar = document.getElementById('progress-bar');
        const convertingName = document.getElementById('converting-name');

        let pendingFilename = null;
        let elapsedTimer = null;
        let stepStartTime = null;
        // Track step divs by step number so we update in-place
        const stepDivs = {};

        // Drag and drop
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', e => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files[0]) uploadFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', () => {
            if (fileInput.files[0]) uploadFile(fileInput.files[0]);
        });

        // Confirm buttons
        confirmStart.addEventListener('click', () => {
            if (pendingFilename) startConversion(pendingFilename);
        });
        confirmCancel.addEventListener('click', () => {
            confirmSection.style.display = 'none';
            uploadSection.style.display = 'block';
            pendingFilename = null;
        });

        async function uploadFile(file) {
            console.log('[DEBUG] uploadFile called:', file.name, file.size, 'bytes');
            if (!file.name.endsWith('.acsm')) {
                alert('Please select an .acsm file');
                return;
            }
            const formData = new FormData();
            formData.append('file', file);
            try {
                console.log('[DEBUG] POST /upload ...');
                const resp = await fetch('/upload', { method: 'POST', body: formData });
                console.log('[DEBUG] /upload response status:', resp.status);
                const data = await resp.json();
                console.log('[DEBUG] /upload response data:', JSON.stringify(data));
                if (data.error) { alert(data.error); return; }
                pendingFilename = data.filename;
                uploadSection.style.display = 'none';
                confirmFilename.textContent = data.filename;
                confirmSection.style.display = 'block';
            } catch (err) {
                console.error('[DEBUG] /upload error:', err);
                alert('Upload failed: ' + err.message);
            }
        }

        let totalSteps = 5;
        let lastRenderedSteps = 0;

        async function startConversion(filename) {
            console.log('[DEBUG] startConversion called:', filename);
            confirmSection.style.display = 'none';
            uploadSection.style.display = 'none';
            progressSection.style.display = 'block';
            convertingName.textContent = filename;
            stepsDiv.innerHTML = '';
            progressBar.value = 0;
            totalSteps = 5;
            lastRenderedSteps = 0;
            Object.keys(stepDivs).forEach(k => delete stepDivs[k]);

            // Start the conversion job
            let jobId;
            try {
                console.log('[DEBUG] POST /start-convert/' + filename);
                const resp = await fetch('/start-convert/' + encodeURIComponent(filename), { method: 'POST' });
                console.log('[DEBUG] /start-convert response status:', resp.status);
                const text = await resp.text();
                console.log('[DEBUG] /start-convert response body:', text);
                let data;
                try { data = JSON.parse(text); } catch(e) {
                    console.error('[DEBUG] Failed to parse JSON:', e);
                    addStep('error', 'Server error: ' + text.substring(0, 200), 'error');
                    return;
                }
                if (data.error) { alert(data.error); return; }
                jobId = data.job_id;
                console.log('[DEBUG] Got job_id:', jobId);
            } catch (err) {
                console.error('[DEBUG] /start-convert error:', err);
                alert('Failed to start conversion: ' + err.message);
                return;
            }

            // Show first step as active
            showActiveStep(1, totalSteps, 'Checking tools...');

            let pollCount = 0;
            // Poll for status every 2 seconds
            const poller = setInterval(async () => {
                pollCount++;
                try {
                    console.log('[DEBUG] Poll #' + pollCount + ' GET /job-status/' + jobId);
                    const resp = await fetch('/job-status/' + encodeURIComponent(jobId));
                    console.log('[DEBUG] Poll #' + pollCount + ' status:', resp.status);
                    const text = await resp.text();
                    console.log('[DEBUG] Poll #' + pollCount + ' body:', text);
                    let data;
                    try { data = JSON.parse(text); } catch(e) {
                        console.error('[DEBUG] Poll JSON parse error:', e);
                        return;
                    }

                    // Render completed steps
                    for (let i = lastRenderedSteps; i < data.steps.length; i++) {
                        const s = data.steps[i];
                        console.log('[DEBUG] Processing step:', JSON.stringify(s));
                        if (s.step === 'done') {
                            Object.values(stepDivs).forEach(d => {
                                if (d.dataset.status === 'active') {
                                    d.dataset.status = 'done';
                                    const el = d.querySelector('.elapsed');
                                    if (el) el.remove();
                                }
                            });
                            stopElapsedTimer();
                            progressBar.value = totalSteps;
                            addStep('done', s.message, 'done');
                            clearInterval(poller);
                            console.log('[DEBUG] Conversion DONE! Reloading in 2s...');
                            setTimeout(() => { window.location.reload(); }, 2000);
                            return;
                        } else {
                            const stepNum = s.step;
                            if (stepDivs[stepNum]) {
                                stopElapsedTimer();
                                const div = stepDivs[stepNum];
                                div.dataset.status = 'done';
                                const el = div.querySelector('.elapsed');
                                if (el) el.remove();
                                div.childNodes[0].textContent = 'Step ' + stepNum + '/' + totalSteps + ': ' + s.message;
                            } else {
                                // Step finished before we polled â€” create it as done
                                const div = document.createElement('div');
                                div.className = 'step';
                                div.dataset.status = 'done';
                                div.textContent = 'Step ' + stepNum + '/' + totalSteps + ': ' + s.message;
                                stepDivs[stepNum] = div;
                                stepsDiv.appendChild(div);
                            }
                            progressBar.value = stepNum;
                        }
                    }
                    lastRenderedSteps = data.steps.length;

                    // Show current active step
                    if (data.status === 'running' && data.current_step > 0) {
                        if (!stepDivs[data.current_step]) {
                            console.log('[DEBUG] Showing active step:', data.current_step, data.current_label);
                            showActiveStep(data.current_step, totalSteps, data.current_label);
                        }
                    }

                    // Handle error
                    if (data.status === 'error') {
                        console.error('[DEBUG] Job ERROR:', data.error);
                        Object.values(stepDivs).forEach(d => {
                            if (d.dataset.status === 'active') {
                                d.dataset.status = 'error';
                                const el = d.querySelector('.elapsed');
                                if (el) el.remove();
                            }
                        });
                        stopElapsedTimer();
                        addStep('error', data.error, 'error');
                        clearInterval(poller);
                        setTimeout(() => { uploadSection.style.display = 'block'; }, 3000);
                    }
                } catch (err) {
                    console.error('[DEBUG] Poll #' + pollCount + ' network error:', err);
                }
            }, 2000);
        }

        function showActiveStep(stepNum, total, label) {
        
